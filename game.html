<!DOCTYPE html>

<%!
    HOLDER_BOTTOM=100

    def fixspace(x):
        return x.replace('+',' ')
%>

<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>TypoRacer</title>

    <style>
        body {
            background-color: black;
            transition: background-color 250ms ease-out;
        }
        body[data-flashing=flash] {
            background-color: darkblue;
            transition: null;
        }
        #title-bar {
            position: fixed;
            left: 20px;
            top: 10px;
            font-family: 'Segoe UI', '微软雅黑', 'Microsoft Yahei', serif;
            font-size: 25px;
            color: white;
            z-index: 140;
            text-shadow: 0 0 5px black;
            transition: opacity .5s ease;
        }
        .game-started #title-bar {
            opacity: .3;
        }
        #title-bar:hover {
            opacity: 1 !important;
        }
        #title-bar a {
            text-decoration: none !important;
            color: inherit !important;
        }
        #bg-image {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            opacity: .5;
        }
        #innocent-holder {
            position: fixed;
            left: 0;
            bottom: ${HOLDER_BOTTOM}px;
            width: 100%;
            height: 10px;
            background-color: lightgreen;
            z-index: 20;
            opacity: .5;
        }
        #below-holder {
            position: fixed;
            width: 100%;
            height: ${HOLDER_BOTTOM}px;
            left: 0;
            bottom: 0;
            background-color: grey;
            z-index: 90;
            opacity: .5;
        }
        .msg-popup {
            position:fixed;
            width:100%;
            font-size: 50px;
            font-family: consolas, monospace;
            left: 0;
            bottom: ${HOLDER_BOTTOM+100}px;
            text-align:center;
            color: white;
            z-index:120;
        }
        .msg-popup.hidden {
            opacity: 0;
            transition: opacity .5s ease-in;
        }
        .hit-obj {
            position: fixed;
            z-index: 10;
        }
        .hit-obj-circle {
            background-color:white;
            left: 25%;
            width: 50%;
        }
        .vanishing {
            opacity: 0;
            transition: opacity 300ms ease-out;
            z-index: 100;
        }
        .hit-obj-circle.vanishing {
            background-color: orange;
        }
        .hit-obj-slider {
            background-color: cornflowerblue;
            left: 35%;
            width: 30%;
            opacity: .6;
        }
        .hit-obj-slider-checker {
            background-color: orange;
            left: 35%;
            width: 30%;
        }
        .hit-obj-spinner {
            background-color: orange;
            left: 0;
            width: 100%;
            opacity: .6;
        }
        .hit-obj-spinner[data-flashing=flash] {
            background-color: orangered !important;
        }
    </style>

</head>
<body>

    <div id="title-bar"><a href="/" target="_self">&lt;返回 &nbsp; ${title|h}</a></div>
    <div id="bg-image" style="background-image: url(${bg_url})"></div>
    <div id="innocent-holder"></div>
    <div id="below-holder"></div>
    <div id="game-stage"></div>
    <div id="msgs"><div class="msg-popup">Press any key to start</div></div>
    <audio src="${audio_url}" preload="auto" id="player"></audio>

    <script>
        var CLAP_TIME_DELTA=30,
            ANTI_FAULT_THRESHOLD=400,
            MISS_THRESHOLD=250,
            SLIDER_END_THRESHOLD=200,
            FALL_SPEED=.75,
            DRAW_CANVAS_THRESHOLD=(screen.height+100)/FALL_SPEED,
            CIRCLE_HEIGHT=10,
            player=document.getElementById('player'),
            stage=document.getElementById('game-stage'),
            msgs=document.getElementById('msgs'),
            hitobjs=[],
            hitobj_nodes={},
            flashtime=[],
            state='idle',
            cur_ind= 0,
            incoming_ind=0,
            flash_ind=0,
            cur_slider=null;

        function msg(txt) {
            var msg_popup=document.createElement('div');
            msg_popup.className='msg-popup';
            msg_popup.textContent=txt;
            if(msgs.childNodes.length)
                msgs.removeChild(msgs.childNodes[0]);
            msgs.appendChild(msg_popup);
            setTimeout(function() {
                msg_popup.className='msg-popup hidden';
                setTimeout(function() {
                    try {
                        msgs.removeChild(msg_popup);
                    } catch(_) {}
                },550);
            },100);
        }

        function keydown_callback(event) {
            if(event.repeat)
                return;
            var time=player.currentTime*1000;
            if(state==='approaching') {
                var curobj=hitobjs[cur_ind],
                    curnod=hitobj_nodes[cur_ind],
                    time_delta=time-curobj.time;
                if(curobj.type==='stop' || curobj.type==='spinner')
                    return;
                if(time_delta<-MISS_THRESHOLD) {
                    stage.removeChild(hitobj_nodes[cur_ind]);
                    delete hitobj_nodes[cur_ind];
                    window.state='idle';
                    window.cur_ind++;
                    msg('Miss');
                    return;
                }
                if(curobj.type==='slider') {
                    if(event.keyCode===32/*space*/) {
                        curnod.style.backgroundColor='blue';
                        var obj_dom=document.createElement('div');
                        obj_dom.className='hit-obj hit-obj-slider-checker';
                        obj_dom.style.height=CIRCLE_HEIGHT+'px';
                        obj_dom.style.bottom=curnod.style.bottom;
                        obj_dom.dataset.stopped=true;
                        stage.appendChild(obj_dom);
                        setTimeout(function() {
                            obj_dom.className=obj_dom.className+' vanishing';
                            setTimeout(function() {
                                stage.removeChild(obj_dom);
                            },350);
                        },100);
                        msg(Math.round(time_delta)+'ms');
                        window.cur_slider=curnod;
                    } else
                        return;
                } else if(curobj.type==='circle') {
                    curnod.className=curnod.className+' vanishing';
                    curnod.dataset.stopped=true;
                    setTimeout(function() {
                       stage.removeChild(curnod);
                    },350);
                    msg(Math.round(time_delta)+'ms');
                } else
                    throw 'bad obj type: '+curobj.type;
                window.cur_ind++;
                window.state='idle';
            } else if(state==='spinner') {
                //todo: spinner counting
                msg('Hit x'+(++hitobjs[cur_ind].count));
                flash(hitobj_nodes[cur_ind]);
            }
        }

        function keyup_callback(event) {
            if(event.keyCode===32/*space*/ && cur_slider!==null) {
                var time_delta=cur_slider.dataset.stop_time-player.currentTime*1000;
                if(time_delta>SLIDER_END_THRESHOLD)
                    msg('Slider '+Math.round(time_delta)+' ms missed');
                else
                    msg('Slider passed');
                stage.removeChild(cur_slider);
                window.cur_slider=null;
            }
        }

        function redraw_stage(time) {
            for(var i=0;i<stage.childNodes.length;i++) {
                var node=stage.childNodes[i];
                if(node.dataset.stopped===undefined)
                    node.style.bottom=(${HOLDER_BOTTOM}+(node.dataset.time-time)*FALL_SPEED)+'px';
            }
        }

        function flash(target) {
            new Audio('/static/clap.wav').play();
            target.dataset.flashing='flash';
            setTimeout(function() {
                target.dataset.flashing='';
            },25);
        }

        function tick() {
            var time=player.currentTime*1000;
            var curobj=hitobjs[cur_ind];

            if(curobj.type==='stop') {
                redraw_stage(time);
                if(curobj.time>time) //still have time to go
                    return requestAnimationFrame(tick);
                else {
                    msg('Well done');
                    setTimeout(function() {
                        location.href='/';
                    },1000);
                    return;
                }
            }

            // note effect
            if(time>=flashtime[flash_ind]) {
                flash(document.body);
                flash_ind++;
                return tick();
            }

            // state maintain
            if(state==='idle') {
                if(curobj.type==='spinner') {
                    if(curobj.time<=time) {
                        curobj.count=0;
                        window.state='spinner';
                    }
                } else if(curobj.time-time<ANTI_FAULT_THRESHOLD)
                    window.state='approaching'
            } else if(state==='approaching') {
                if(time-curobj.time>MISS_THRESHOLD) {
                    stage.removeChild(hitobj_nodes[cur_ind]);
                    delete hitobj_nodes[cur_ind];
                    window.state='idle';
                    window.cur_ind++;
                    //todo: handle miss
                    msg('Miss');
                    return tick();
                }
            } else if(state==='spinner') {
                if(curobj.stop_time<time) {
                    console.log('quit spinner');
                    window.state='idle';
                    stage.removeChild(hitobj_nodes[cur_ind]);
                    window.cur_ind++;
                    return tick();
                }
            } else
                throw 'bad state: '+state;

            // generate new hit obj
            // fixme: disclaimer: the last hit object MUST BE stop!
            if(incoming_ind<hitobjs.length-1 && hitobjs[incoming_ind].time-time<DRAW_CANVAS_THRESHOLD) {
                var nxtobj=hitobjs[incoming_ind];
                var obj_dom=document.createElement('div');
                obj_dom.dataset.time=nxtobj.time;
                obj_dom.className='hit-obj hit-obj-'+nxtobj.type;
                if(nxtobj.type==='circle')
                    obj_dom.style.height=CIRCLE_HEIGHT+'px';
                else if(nxtobj.type==='slider' || nxtobj.type==='spinner') {
                    obj_dom.style.height=((nxtobj.stop_time-nxtobj.time)*FALL_SPEED)+'px';
                    obj_dom.dataset.stop_time=nxtobj.stop_time;
                }
                else
                    throw 'bad obj type: '+nxtobj.type;

                console.log('hit object created: #'+incoming_ind+' type='+nxtobj.type);
                hitobj_nodes[incoming_ind]=obj_dom;
                stage.appendChild(obj_dom);
                incoming_ind++;
            }

            // redraw hit objs
            redraw_stage(time);

            requestAnimationFrame(tick);
        }

        function start() {
            document.body.className='game-started';
            removeEventListener('keydown',start);
            addEventListener('keydown',keydown_callback);
            addEventListener('keyup',keyup_callback);
            player.play();
            msg('Started');
        }

        window.hitobjs=JSON.parse(decodeURIComponent('${beatmap|u,fixspace}'));
        for(var i=0;i<hitobjs.length;i++) {
            flashtime.push(hitobjs[i].time-CLAP_TIME_DELTA);
            if(hitobjs[i].type==='slider') {
                flashtime.push(hitobjs[i].stop_time-CLAP_TIME_DELTA);
            }
        }
        window.flashtime=flashtime.sort(function(fuck,js){return fuck-js;});
        hitobjs.push({time: Math.round(player.duration*1000)-5, type:'stop'});
        requestAnimationFrame(tick);
        addEventListener('keydown',start);
    </script>

</body>
</html>